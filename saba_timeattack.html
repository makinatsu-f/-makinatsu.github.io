<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>サバタップゲーム・タイムアタック！</title>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      height: 100vh;
      overflow: hidden;
      background: #003f7f;
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", sans-serif;
    }

    /* 海背景 */
    .sea {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(#3fa9f5, #003f7f);
      overflow: hidden;
      touch-action: manipulation;
    }

    /* 上のHUDエリア（タイトル＋タイマー） */
    #hud {
      position: fixed;
      left: 0;
      top: env(safe-area-inset-top);
      width: 100%;
      padding: 12px 16px 0;
      z-index: 9999;
      color: #fff;
      text-shadow: 0 2px 6px rgba(0,0,0,.35);
      user-select: none;
      pointer-events: none;
    }

    #title {
      font-weight: 800;
      font-size: 18px;
      text-align: left;
      margin-bottom: 4px;
    }

    #timerArea {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      pointer-events: none;
    }

    #timeLabel {
      font-weight: 700;
      font-size: 18px;
    }

    #timeValue {
      font-weight: 900;
      font-size: 22px;
      letter-spacing: 1px;
    }

    #starIcon {
      font-size: 20px;
      opacity: 0;
      transition: opacity .15s ease, transform .15s ease;
      transform: scale(0.6);
    }
    #starIcon.flash {
      opacity: 1;
      transform: scale(1.1);
    }

    /* スコアボックス（ドラッグで動かせる） */
    #scoreBox {
      position: fixed;
      left: 12px;
      top: calc(env(safe-area-inset-top) + 60px);
      z-index: 99999;
      padding: 8px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,.32);
      color: #fff;
      font-size: 14px;
      font-weight: 700;
      text-shadow: 0 2px 6px rgba(0,0,0,.35);
      user-select: none;
      touch-action: none;
      cursor: grab;
    }
    #scoreBox:active { cursor: grabbing; }

    #scoreBox div {
      line-height: 1.5;
    }
    #scoreBox .score-main {
      margin-top: 4px;
      font-size: 16px;
      font-weight: 900;
    }

    /* 魚画像 */
    .fish {
      position: absolute;
      user-select: none;
      -webkit-user-drag: none;
      cursor: pointer;

      /* タップ判定を少し広げる */
      padding: 18px;
      margin: -18px;
    }

    /* タップしたときのちょい演出 */
    .pop {
      transform: scale(1.08);
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
      transition: transform .08s;
    }

    /* モード選択のオーバーレイ */
    #modeOverlay,
    #resultOverlay {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 16px;
      background: radial-gradient(circle at center, rgba(0,0,0,.35), rgba(0,0,0,.65));
      color: #fff;
      z-index: 100000;
      text-align: center;
      padding: 24px;
    }

    #modeTitle,
    #resultTitle {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 4px;
      text-shadow: 0 3px 10px rgba(0,0,0,.6);
    }

    .modeBtn,
    .againBtn {
      display: block;
      width: 220px;
      max-width: 70vw;
      padding: 12px 16px;
      border-radius: 999px;
      border: none;
      background: #8ECFEA;      /* 淡い海ブルー */
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
      color: #ffffff;
      font-size: 16px;
      font-weight: 800;
      letter-spacing: 0.5px;
      cursor: pointer;
    }
    .modeBtn + .modeBtn {
      margin-top: 8px;
    }
    .modeBtn:active,
    .againBtn:active {
      transform: scale(0.97);
    }

    .subText {
      font-size: 13px;
      opacity: .9;
    }

    /* 結果テキスト */
    #resultBody {
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 8px;
    }

    /* 「スタート！」のアニメ */
    #startFlash {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(0.4);
      font-size: 32px;
      font-weight: 900;
      color: #fff;
      text-shadow: 0 3px 12px rgba(0,0,0,.7);
      opacity: 0;
      pointer-events: none;
      z-index: 99999;
      transition: opacity .15s ease, transform .25s ease-out;
    }
    #startFlash.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.06);
    }
  </style>
</head>
<body>
  <!-- 上部HUD -->
  <div id="hud">
    <div id="title">サバタップゲーム・タイムアタック！</div>
    <div id="timerArea">
      <span id="timeLabel">TIME</span>
      <span id="timeValue">--</span>
      <span id="starIcon">⭐️</span>
    </div>
  </div>

  <!-- スコアボックス（ドラッグOK） -->
  <div id="scoreBox">
    <div>取り逃し：<span id="miss">0</span></div>
    <div>サバ出現数：<span id="total">0</span></div>
    <div class="score-main">SCORE：<span id="score">0</span>点</div>
  </div>

  <!-- 海エリア -->
  <div class="sea" id="sea"></div>

  <!-- モード選択オーバーレイ -->
  <div id="modeOverlay">
    <div id="modeTitle">サバタップゲーム・タイムアタック！</div>
    <div class="subText">あそぶ時間をえらんでね</div>
    <button class="modeBtn" data-sec="30">30秒であそぶ</button>
    <button class="modeBtn" data-sec="60">60秒であそぶ</button>
  </div>

  <!-- 結果表示オーバーレイ（最初は非表示） -->
  <div id="resultOverlay" style="display:none;">
    <div id="resultTitle">TIME UP!</div>
    <div id="resultBody"></div>
    <button class="againBtn" id="againBtn">もういちどあそぶ</button>
  </div>

  <!-- 「スタート！」 -->
  <div id="startFlash">スタート！</div>

  <script>
    const sea = document.getElementById("sea");

    // スコア関連
    const scoreSpan = document.getElementById("score");
    const missSpan  = document.getElementById("miss");
    const totalSpan = document.getElementById("total");

    // タイマー関連
    const timeValue = document.getElementById("timeValue");
    const starIcon  = document.getElementById("starIcon");

    // オーバーレイ
    const modeOverlay   = document.getElementById("modeOverlay");
    const resultOverlay = document.getElementById("resultOverlay");
    const resultBody    = document.getElementById("resultBody");
    const startFlash    = document.getElementById("startFlash");

    let score = 0;
    let totalFish = 0;
    let missCount = 0;
    let gameRunning = false;
    let selectedSeconds = 30;
    let remainingSec = 0;

    const fishes = []; // { el, x, y, speed, type, alive, isGolden }

    let spawnTimerId = null;
    let gameTimerId  = null;
    let goldenTimerId = null;

    // 魚の設定
    const NORMAL_SABA = {
      name: "saba",
      src: "images/saba.png",
      size: 110,
      speedMin: 1.7,
      speedMax: 3.0,
      points: 1
    };

    const GOLDEN_SABA = {
      name: "goldensaba",
      src: "images/goldensaba.png",
      size: 110 * 1.5,           // 1.5倍
      speedMin: 1.7 * 4.0,       // 2倍速
      speedMax: 3.0 * 5.0,
      points: 10
    };

    const SPAWN_INTERVAL = 650;
    const OFFSCREEN = 260;
    const MAX_FISH_ON_SCREEN = 16;

    function rand(min, max){ return Math.random() * (max - min) + min; }

    function updateScoreBoard(){
      scoreSpan.textContent = String(score);
      missSpan.textContent  = String(missCount);
      totalSpan.textContent = String(totalFish);
    }

    function spawnFish(isGolden=false, yOverride=null, speedOverride=null){
      if (!gameRunning) return;
      if (fishes.length >= MAX_FISH_ON_SCREEN && !isGolden) return;

      const seaW = sea.clientWidth;
      const seaH = sea.clientHeight;

      const type = isGolden ? GOLDEN_SABA : NORMAL_SABA;

      const img = document.createElement("img");
      img.src = type.src;
      img.alt = type.name;
      img.className = "fish";
      img.style.height = type.size + "px";

      const x = seaW + rand(20, OFFSCREEN);
      const y = (yOverride != null)
        ? yOverride
        : rand(30, Math.max(40, seaH - type.size - 30));

      let speed = speedOverride != null
        ? speedOverride
        : rand(type.speedMin, type.speedMax);

      img.style.left = x + "px";
      img.style.top  = y + "px";

      const fishObj = { el: img, x, y, speed, type, alive: true, isGolden };

      // 出現数カウント（通常も黄金も）
      totalFish++;
      updateScoreBoard();

      function catchIt(ev){
        ev.preventDefault?.();
        if (!gameRunning) return;
        if (!fishObj.alive) return;

        fishObj.alive = false;
        img.classList.add("pop");

        score += type.points;
        updateScoreBoard();

        setTimeout(()=>{
          img.remove();
        }, 60);
      }

      img.addEventListener("click", catchIt);
      img.addEventListener("touchstart", catchIt, { passive:false });

      sea.appendChild(img);
      fishes.push(fishObj);
    }

    function spawnNormalFish(){
      spawnFish(false);
    }

    // 黄金サバスケジューラ
    function scheduleGolden(){
      clearTimeout(goldenTimerId);
      if (!gameRunning) return;

      // 次の黄金まで 5〜12秒くらいのランダム
      const delay = Math.floor(rand(5000, 12000));

      goldenTimerId = setTimeout(()=>{
        if (!gameRunning || remainingSec <= 3) return;

        // ⭐️ をピカピカ
        starIcon.classList.add("flash");
        setTimeout(()=>{
          starIcon.classList.remove("flash");
          // すこしして黄金サバ出現
          setTimeout(()=>{
            if (!gameRunning) return;
            spawnFish(true); // 黄金
            scheduleGolden(); // 次の黄金も予約
          }, 300);
        }, 500);
      }, delay);
    }

    // 位置更新
    function tick(){
      const seaW = sea.clientWidth;

      for(let i=fishes.length - 1; i >= 0; i--){
        const f = fishes[i];
        if (!f.alive){
          fishes.splice(i,1);
          continue;
        }

        f.x -= f.speed;
        f.el.style.left = f.x + "px";

        if (f.x < -OFFSCREEN){
          // 取り逃し判定
          missCount++;
          updateScoreBoard();

          f.el.remove();
          fishes.splice(i,1);
        }
      }

      requestAnimationFrame(tick);
    }

    // ===== ゲーム開始／終了 =====
    function startGame(seconds){
      // 全リセット
      score = 0;
      totalFish = 0;
      missCount = 0;
      updateScoreBoard();

      // 既存の魚を全部削除
      fishes.forEach(f => f.el.remove());
      fishes.length = 0;

      selectedSeconds = seconds;
      remainingSec   = seconds;
      timeValue.textContent = String(remainingSec);

      gameRunning = true;

      // スタート演出
      startFlash.classList.add("show");
      setTimeout(()=>{ startFlash.classList.remove("show"); }, 700);

      // スポーン＆タイマー開始
      clearInterval(spawnTimerId);
      spawnTimerId = setInterval(spawnNormalFish, SPAWN_INTERVAL);

      clearInterval(gameTimerId);
      gameTimerId = setInterval(()=>{
        if (!gameRunning) return;
        remainingSec--;
        if (remainingSec < 0) remainingSec = 0;
        timeValue.textContent = String(remainingSec);

        if (remainingSec <= 0){
          endGame();
        }
      }, 1000);

      // 黄金サバスケジューラ開始
      scheduleGolden();
    }

    function endGame(){
      if (!gameRunning) return;
      gameRunning = false;

      clearInterval(spawnTimerId);
      clearInterval(gameTimerId);
      clearTimeout(goldenTimerId);
      starIcon.classList.remove("flash");

      // 結果表示
      resultBody.innerHTML =
        `プレイ時間：${selectedSeconds}秒<br>` +
        `SCORE：${score}点<br>` +
        `サバ出現数：${totalFish}<br>` +
        `取り逃し：${missCount}`;

      resultOverlay.style.display = "flex";
    }

    // ===== モード選択ボタン =====
    document.querySelectorAll(".modeBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const sec = Number(btn.dataset.sec || "30");
        modeOverlay.style.display = "none";
        resultOverlay.style.display = "none";
        startGame(sec);
      });
    });

    document.getElementById("againBtn").addEventListener("click", ()=>{
      resultOverlay.style.display = "none";
      modeOverlay.style.display = "flex";
    });

    // ===== スコアボックスのドラッグ処理 =====
    const scoreBox = document.getElementById("scoreBox");

    const saved = JSON.parse(localStorage.getItem("scorePos") || "null");
    if (saved && typeof saved.x === "number" && typeof saved.y === "number") {
      scoreBox.style.left = saved.x + "px";
      scoreBox.style.top  = saved.y + "px";
    }

    let dragging = false;
    let offsetX = 0, offsetY = 0;

    function clamp(n, min, max){ return Math.min(max, Math.max(min, n)); }

    function onDown(e){
      dragging = true;
      const p = e.touches ? e.touches[0] : e;
      const rect = scoreBox.getBoundingClientRect();
      offsetX = p.clientX - rect.left;
      offsetY = p.clientY - rect.top;
      e.preventDefault();
    }

    function onMove(e){
      if (!dragging) return;
      const p = e.touches ? e.touches[0] : e;

      const w = scoreBox.offsetWidth;
      const h = scoreBox.offsetHeight;

      const x = clamp(p.clientX - offsetX, 0, window.innerWidth - w);
      const y = clamp(p.clientY - offsetY, 0, window.innerHeight - h);

      scoreBox.style.left = x + "px";
      scoreBox.style.top  = y + "px";

      localStorage.setItem("scorePos", JSON.stringify({x, y}));
      e.preventDefault();
    }

    function onUp(){
      dragging = false;
    }

    scoreBox.addEventListener("mousedown", onDown);
    window.addEventListener("mousemove", onMove);
    window.addEventListener("mouseup", onUp);

    scoreBox.addEventListener("touchstart", onDown, {passive:false});
    window.addEventListener("touchmove", onMove, {passive:false});
    window.addEventListener("touchend", onUp);

    // アニメーションループ開始
    requestAnimationFrame(tick);
  </script>
</body>
</html>

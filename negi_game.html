<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒã‚®åç©«ã‚²ãƒ¼ãƒ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      background-color: #f7f3e9;
      color: #553322;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
      background-image: url("images/bg_negi_field.png");
      background-size: cover;
      background-position: center;
    }

    .wrapper {
      max-width: 480px;
      margin: 0 auto;
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ä¸Šï¼šHUD */
    .hud { text-align: center; padding: 10px 0 6px; }

    .score {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.08em;
      padding: 4px 12px;
      border-radius: 999px;
      border: 2px solid #ffb15a;
      display: inline-block;
      background: rgba(255, 248, 235, 0.9);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.12);
    }

    .score span { min-width: 60px; display: inline-block; text-align: right; }

    .life-bar {
      margin: 6px auto 0;
      display: inline-block;
      padding: 6px 12px;
      border-radius: 999px;
      border: 2px solid #e2c9a3;
      background: rgba(255, 255, 255, 0.75);
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    /* ã“ã“ã‚’ã€Œå¤§ãã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¾ãƒ¼ãƒ³ã€ã«ã™ã‚‹ */
    #rule-text {
      text-align: center;
      font-size: 1.15rem;
      line-height: 1.6;
      color: #553322;
      font-weight: 900;
      margin: 10px 12px 0;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.70);
      border-radius: 14px;
      backdrop-filter: blur(4px);
      min-height: 3.2em;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .rule-flash {
      outline: 3px solid rgba(255, 177, 90, 0.55);
      transform: translateY(-1px);
    }

    .invincible .score {
      animation: glow 0.6s ease-in-out infinite alternate;
      border-color: #ffd700;
    }

    @keyframes glow {
      from { box-shadow: 0 0 6px rgba(255, 215, 0, 0.5); }
      to   { box-shadow: 0 0 14px rgba(255, 215, 0, 1); }
    }

    /* ä¸­ï¼šã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
    #game-area {
      position: relative;
      flex: 1;
      overflow: hidden;
      background-image: url("images/bg_negi_field.png");
      background-size: cover;
      background-position: center bottom;
      border-top: 2px solid #e2c9a3;
      border-bottom: 2px solid #e2c9a3;
    }

    .lane-helper {
      position: absolute;
      left: 0; right: 0;
      top: 52%;
      transform: translateY(-50%);
      height: 0;
    }

    /* ãƒã‚®ï¼šã‚¹ãƒãƒ›ã§ã‚¿ãƒƒãƒ—ã—ã‚„ã™ãå¤§ãã‚ */
    .leek {
      position: absolute;
      bottom: 6vh;
      width: 30vw;          /* å¤§ãã */
      min-width: 120px;     /* å°ã•ããªã‚Šéãé˜²æ­¢ */
      max-width: 220px;     /* å¤§ãéãé˜²æ­¢ */
      cursor: pointer;
      touch-action: manipulation;
      transition: transform 0.08s;
      -webkit-tap-highlight-color: transparent;
    }
    .leek:active { transform: translateY(3px) scale(0.97); }

    /* ä¸‹ï¼šãƒœã‚¿ãƒ³ */
    .controls { padding: 10px 16px 18px; text-align: center; }

    .btn-main {
      display: inline-block;
      padding: 12px 28px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(180deg, #ffb15a, #ff8b3d);
      color: #fff;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: 0.08em;
      box-shadow: 0 5px 0 #d96c23;
      cursor: pointer;
    }
    .btn-main:active { transform: translateY(2px); box-shadow: 0 3px 0 #d96c23; }

    /* ãƒªãƒˆãƒ©ã‚¤ã‚’è¦‹ãˆã‚„ã™ãã€ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã«ä¸»å½¹ã«ã™ã‚‹ */
    .btn-retry {
      display: none;
      margin-top: 10px;
      width: min(320px, 92%);
      padding: 14px 18px;
      font-size: 20px;
      font-weight: 900;
      border-radius: 16px;
      border: 3px solid rgba(255, 177, 90, 0.7);
      background: rgba(255, 255, 255, 0.92);
      color: #553322;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }
    .btn-retry:active { transform: translateY(2px); }

    .small-note { margin-top: 6px; font-size: 10px; color: #b2997c; }
  </style>
</head>

<body>
  <div class="wrapper">
    <!-- ä¸Šï¼šã‚¹ã‚³ã‚¢ -->
    <header class="hud">
      <div class="score">
        SCORE: <span id="score-value">0</span>
      </div>

      <div class="life-bar" id="life-bar">
        ãƒ©ã‚¤ãƒ•: <span id="life-value">7</span> / 7
      </div>

      <!-- ã“ã“ã«å¤§ãããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™ -->
      <div id="rule-text"></div>
    </header>

    <!-- ä¸­ï¼šã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ -->
    <main id="game-area">
      <div class="lane-helper" id="lane-helper"></div>
    </main>

    <!-- ä¸‹ï¼šãƒœã‚¿ãƒ³ -->
    <footer class="controls">
      <button id="start-btn" class="btn-main">åç©«é–‹å§‹ï¼</button>
      <button id="retry-btn" class="btn-retry">ã‚‚ã†ä¸€å›åç©«ã™ã‚‹ï¼</button>

      <div class="small-note">
        â€» æ¯ã‚Œãƒã‚®ãƒ»æŠ˜ã‚Œãƒã‚®ã‚’è¦‹é€ƒã™ã¨ãƒ©ã‚¤ãƒ•ãŒæ¸›ã‚‹ã‚ˆã€‚<br>
        â€» é‡‘ãƒã‚®ã¯ +10ç‚¹ ï¼† 5ç§’é–“ã€Œæ¸›ç‚¹ã‚‚ãƒ©ã‚¤ãƒ•æ¸›å°‘ã‚‚ãªã—ã€âœ¨
      </div>
    </footer>
  </div>

  <script>
    // ==== ç”»åƒã¨ãƒã‚®ã‚¿ã‚¤ãƒ—è¨­å®š =========================
    const NEGI_TYPES = {
      good: [
        { name: "ç´°ãƒã‚®",  file: "negi_hoso.png" },
        { name: "æ™®é€šãƒã‚®", file: "negi_futsu.png" },
        { name: "å¤ªãƒã‚®",  file: "negi_futo.png" }
      ],
      bad: [
        { name: "æ¯ã‚Œãƒã‚®", file: "negi_kare.png" },
        { name: "æŠ˜ã‚Œãƒã‚®", file: "negi_ore.png" }
      ],
      gold: [
        { name: "é‡‘ãƒã‚®", file: "negi_gold.png" }
      ]
    };

    // ==== DOMå–å¾— =======================
    const gameArea = document.getElementById("game-area");
    const laneHelper = document.getElementById("lane-helper");
    const scoreValueEl = document.getElementById("score-value");
    const lifeValueEl = document.getElementById("life-value");
    const startBtn = document.getElementById("start-btn");
    const retryBtn = document.getElementById("retry-btn");
    const bodyEl = document.body;
    const ruleTextEl = document.getElementById("rule-text");

    // ==== ãƒ«ãƒ¼ãƒ«æ–‡ï¼ˆé€šå¸¸è¡¨ç¤ºï¼‰ =====================
    const DEFAULT_RULE_HTML =
      'æ¯ã‚Œãƒã‚®ãƒ»æŠ˜ã‚Œãƒã‚®ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å–ã‚Šé™¤ã“ã†ï¼<br>' +
      'é‡‘ãƒã‚®ã¯ã‚¿ãƒƒãƒ—ã§ +10ç‚¹ ï¼† 5ç§’é–“ãƒŸã‚¹ã—ã¦ã‚‚æ¸›ç‚¹ã‚‚ãƒ©ã‚¤ãƒ•æ¸›å°‘ã‚‚ãªã—âœ¨';

    // ==== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ =====================
    let score = 0;
    let life = 7;
    let gameRunning = false;
    let leeks = [];
    let spawnTimer = null;
    let moveTimer = null;

    let speed = 3.2;                 // å…¨ä½“ã®åŸºæº–ã‚¹ãƒ”ãƒ¼ãƒ‰ï¼ˆä¸Šã’ãŸï¼‰
    let speedLevelTimer = null;
    let invincible = false;
    let invincibleTimeoutId = null;

    // å‡ºç¾ã¨é›£æ˜“åº¦
    const SPAWN_INTERVAL = 650;      // å‡ºç¾é–“éš”ï¼ˆå°‘ã—å¤šã‚ï¼‰
    const BASE_SPEED = 3.2;
    const SPEED_UP_INTERVAL = 10000; // 10ç§’ã”ã¨ã«å°‘ã—ä¸Šã’ã‚‹ï¼ˆä»»æ„ï¼‰
    const SPEED_UP_AMOUNT = 0.25;

    // ==== è¡¨ç¤ºç³» =====================
    function updateScore(delta) {
      score += delta;
      if (score < 0) score = 0;
      scoreValueEl.textContent = score;
    }

    function setLife(newLife) {
      life = Math.max(0, Math.min(7, newLife));
      lifeValueEl.textContent = life;
      if (life <= 0) {
        stopGame(true);
      }
    }

    // ã€ŒãƒŸã‚¹ã€å‡¦ç†ï¼ˆãƒ©ã‚¤ãƒ•æ¸›å°‘ï¼‰
    function registerMiss(message) {
      if (invincible) {
        flashRuleMessage("ç„¡æ•µä¸­âœ¨ ã„ã¾ã®ãƒŸã‚¹ã¯ãƒãƒ¼ã‚«ã‚¦ãƒ³ãƒˆï¼", 900);
        return;
      }
      setLife(life - 1);
      flashRuleMessage(message + `ï¼ˆãƒ©ã‚¤ãƒ• ${life}/7ï¼‰`, 1000);
    }

    let ruleMsgTimer = null;
    function flashRuleMessage(html, ms = 900) {
      clearTimeout(ruleMsgTimer);
      ruleTextEl.innerHTML = html;
      ruleTextEl.classList.add("rule-flash");
      ruleMsgTimer = setTimeout(() => {
        ruleTextEl.classList.remove("rule-flash");
        ruleTextEl.innerHTML = DEFAULT_RULE_HTML;
      }, ms);
    }

    function clearAllLeeks() {
      leeks.forEach(obj => {
        if (obj.el && obj.el.parentNode) obj.el.parentNode.removeChild(obj.el);
      });
      leeks = [];
    }

    function stopGameTimers() {
      clearInterval(spawnTimer);
      clearInterval(moveTimer);
      clearInterval(speedLevelTimer);
      spawnTimer = null;
      moveTimer = null;
      speedLevelTimer = null;
    }

    function setInvincible(on) {
      invincible = on;
      if (on) {
        bodyEl.classList.add("invincible");
      } else {
        bodyEl.classList.remove("invincible");
      }
    }

    // ==== ãƒã‚®ã‚’ä½œã£ã¦æµã™ =====================
    function spawnLeek() {
      if (!gameRunning) return;

      const rand = Math.random();
      let typeGroup;
      let kind;

      // å‡ºç¾ç¢ºç‡ï¼ˆæ‚ªã„ãƒã‚®å¤šã‚ã«å¤‰æ›´ï¼‰
      // good 38% / bad 57% / gold 5%
      if (rand < 0.38) {
        typeGroup = NEGI_TYPES.good;
        kind = "good";
      } else if (rand < 0.95) {
        typeGroup = NEGI_TYPES.bad;
        kind = "bad";
      } else {
        typeGroup = NEGI_TYPES.gold;
        kind = "gold";
      }

      const data = typeGroup[Math.floor(Math.random() * typeGroup.length)];

      const gameRect = gameArea.getBoundingClientRect();
      const yBottom = gameRect.height * 0.20;

      const img = document.createElement("img");
      img.src = "images/" + data.file;
      img.alt = data.name;
      img.className = "leek";
      img.draggable = false;
      img.style.bottom = yBottom + "px";

      // ã¾ãš obj ã‚’ä½œã£ã¦ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
      const obj = {
        el: img,
        kind,
        name: data.name,
        x: -Math.max(180, gameRect.width * 0.35), // å·¦å¤–ã‹ã‚‰
        speed: 0,
        width: 0
      };

      // ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’ã€Œæ—©ãã€ã€Œãƒ©ãƒ³ãƒ€ãƒ å¹…ã‚’å¤§ããã€ã™ã‚‹
      // ã•ã‚‰ã«ã€Œç™½ãƒã‚®(good)ã¯å°‘ã—é€Ÿã‚ã€ã«ã™ã‚‹
      const base = speed + (kind === "good" ? 1.2 : 0.6);
      obj.speed = base + Math.random() * 2.8; // ãƒ©ãƒ³ãƒ€ãƒ å¹…ã‚’å¤§ãã

      img.style.left = obj.x + "px";

      img.addEventListener("click", () => handleTapLeek(obj));
      img.addEventListener("touchend", (e) => {
        e.preventDefault();
        handleTapLeek(obj);
      });

      gameArea.appendChild(img);

      requestAnimationFrame(() => {
        obj.width = img.getBoundingClientRect().width || 120;
      });

      leeks.push(obj);
    }

    function moveLeeks() {
      if (!gameRunning) return;

      const gameRect = gameArea.getBoundingClientRect();
      const removeList = [];

      leeks.forEach(obj => {
        obj.x += obj.speed;
        obj.el.style.left = obj.x + "px";

        if (obj.x > gameRect.width + 10) {
          handleLeekReachedRight(obj);
          removeList.push(obj);
        }
      });

      removeList.forEach(obj => {
        if (obj.el && obj.el.parentNode) obj.el.parentNode.removeChild(obj.el);
        const idx = leeks.indexOf(obj);
        if (idx >= 0) leeks.splice(idx, 1);
      });
    }

    // ==== åˆ¤å®š =====================
    function handleLeekReachedRight(obj) {
      if (obj.kind === "good") {
        // è‰¯ã„ãƒã‚®ï¼šå³ã¾ã§æµã—ãŸã‚‰ +1ç‚¹
        updateScore(1);
      } else if (obj.kind === "bad") {
        // æ‚ªã„ãƒã‚®ï¼šè¦‹é€ƒã—ã¯ãƒŸã‚¹ï¼ˆãƒ©ã‚¤ãƒ•-1ã€ç„¡æ•µä¸­ã¯ãƒãƒ¼ã‚«ã‚¦ãƒ³ãƒˆï¼‰
        updateScore(invincible ? 0 : -1);
        registerMiss(`è¦‹é€ƒã—ï¼${obj.name}ãŒæµã‚Œã¡ã‚ƒã£ãŸğŸ’¦`);
      } else if (obj.kind === "gold") {
        // é‡‘ãƒã‚®ï¼šå³ã¾ã§è¡Œã£ãŸã‚‰ +1ç‚¹ï¼ˆè¦‹é€ƒã—ã§ã‚‚OKï¼‰
        updateScore(1);
      }
    }

    function handleTapLeek(obj) {
      if (!gameRunning || !obj.el) return;
      if (!gameArea.contains(obj.el)) return;

      if (obj.kind === "good") {
        // è‰¯ã„ãƒã‚®ã‚’ã‚¿ãƒƒãƒ— â†’ ãƒŸã‚¹ï¼ˆãƒ©ã‚¤ãƒ•-1ã€ç„¡æ•µä¸­ã¯ãƒãƒ¼ã‚«ã‚¦ãƒ³ãƒˆï¼‰
        updateScore(invincible ? 0 : -1);
        registerMiss("ã¡ãŒã†ï¼è‰¯ã„ãƒã‚®ã‚’å–ã£ã¡ã‚ƒã£ãŸğŸ¥²");
      } else if (obj.kind === "bad") {
        // æ‚ªã„ãƒã‚®ã‚’ã‚¿ãƒƒãƒ—ï¼šæ­£è§£
        flashRuleMessage("ãƒŠã‚¤ã‚¹ï¼å‚·ã‚“ã ãƒã‚®ã‚’å–ã‚Šé™¤ã„ãŸğŸ‘Œ", 700);
      } else if (obj.kind === "gold") {
        // é‡‘ãƒã‚®ï¼š+10ç‚¹ & ç„¡æ•µ5ç§’ï¼ˆæ¸›ç‚¹ã‚‚ãƒ©ã‚¤ãƒ•æ¸›å°‘ã‚‚ãªã—ï¼‰
        updateScore(10);
        flashRuleMessage("é‡‘ãƒã‚®ã‚²ãƒƒãƒˆï¼5ç§’é–“ãƒãƒ¼ãƒšãƒŠãƒ«ãƒ†ã‚£âœ¨", 1100);
        setInvincible(true);
        clearTimeout(invincibleTimeoutId);
        invincibleTimeoutId = setTimeout(() => setInvincible(false), 5000);
      }

      // ãƒã‚®ã‚’æ¶ˆã™
      if (obj.el && obj.el.parentNode) obj.el.parentNode.removeChild(obj.el);
      const idx = leeks.indexOf(obj);
      if (idx >= 0) leeks.splice(idx, 1);
    }

    // ==== ãƒ«ãƒ¼ãƒ— =====================
    function startSpawnLoop() {
      spawnTimer = setInterval(spawnLeek, SPAWN_INTERVAL);
    }

    // ==== ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ»çµ‚äº† =====================
    function startGame() {
      score = 0;
      updateScore(0);
      setLife(7);
      clearAllLeeks();
      stopGameTimers();
      setInvincible(false);

      ruleTextEl.innerHTML = DEFAULT_RULE_HTML;

      gameRunning = true;
      speed = BASE_SPEED;

      startBtn.textContent = "ãƒ—ãƒ¬ã‚¤ä¸­â€¦";
      startBtn.disabled = true;

      retryBtn.style.display = "none";

      startSpawnLoop();
      moveTimer = setInterval(moveLeeks, 1000 / 60);

      // æ™‚é–“åˆ¶é™ã¯ç„¡ã—ã€‚é›£æ˜“åº¦ã ã‘ã‚†ã‚‹ãä¸Šã’ãŸã„å ´åˆã¯ã“ã‚ŒãŒåŠ¹ã
      speedLevelTimer = setInterval(() => {
        speed += SPEED_UP_AMOUNT;
      }, SPEED_UP_INTERVAL);

      flashRuleMessage("åç©«ã‚¹ã‚¿ãƒ¼ãƒˆï¼æ‚ªã„ãƒã‚®ã‚’å©ã‘ãƒ¼ã£ğŸŒ¿", 900);
    }

    function stopGame(isGameOver = false) {
      gameRunning = false;
      stopGameTimers();
      setInvincible(false);

      startBtn.textContent = "åç©«é–‹å§‹ï¼";
      startBtn.disabled = false;

      if (isGameOver) {
        ruleTextEl.innerHTML = `ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼<br>æœ€çµ‚ã‚¹ã‚³ã‚¢ï¼š<b>${score}</b>`;
        retryBtn.style.display = "inline-block";
      } else {
        ruleTextEl.innerHTML = DEFAULT_RULE_HTML;
        retryBtn.style.display = "inline-block";
      }
    }

    // ==== ã‚¤ãƒ™ãƒ³ãƒˆ =========================
    startBtn.addEventListener("click", () => {
      startGame();
    });

    retryBtn.addEventListener("click", () => {
      startGame();
    });

    window.addEventListener("resize", () => {
      leeks.forEach(obj => {
        obj.x = parseFloat(obj.el.style.left) || obj.x;
      });
    });

    // åˆæœŸè¡¨ç¤º
    ruleTextEl.innerHTML = DEFAULT_RULE_HTML;
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒã‚®åç©«ã‚²ãƒ¼ãƒ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      background-color: #f7f3e9;
      color: #553322;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
      background-image: url("images/bg_negi_field.png");
      background-size: cover;
      background-position: center;
    }

    .wrapper {
      max-width: 480px;
      margin: 0 auto;
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ä¸Šï¼šHUD */
    .hud { text-align: center; padding: 10px 0 6px; }

    .score {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.08em;
      padding: 4px 12px;
      border-radius: 999px;
      border: 2px solid #ffb15a;
      display: inline-block;
      background: rgba(255, 248, 235, 0.9);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.12);
    }
    .score span { min-width: 60px; display: inline-block; text-align: right; }

    .life-bar {
      margin: 6px auto 0;
      display: inline-block;
      padding: 6px 12px;
      border-radius: 999px;
      border: 2px solid #e2c9a3;
      background: rgba(255, 255, 255, 0.75);
      font-size: 14px;
      font-weight: 800;
      letter-spacing: 0.05em;
    }

    /* ã“ã“ãŒå¤§ãã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¾ãƒ¼ãƒ³ */
    #rule-text {
      text-align: center;
      font-size: 1.15rem;
      line-height: 1.6;
      color: #553322;
      font-weight: 900;
      margin: 10px 12px 0;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.70);
      border-radius: 14px;
      backdrop-filter: blur(4px);
      min-height: 3.2em;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .rule-flash {
      outline: 3px solid rgba(255, 177, 90, 0.55);
      transform: translateY(-1px);
    }

    .invincible .score {
      animation: glow 0.6s ease-in-out infinite alternate;
      border-color: #ffd700;
    }
    @keyframes glow {
      from { box-shadow: 0 0 6px rgba(255, 215, 0, 0.5); }
      to   { box-shadow: 0 0 14px rgba(255, 215, 0, 1); }
    }

    /* ä¸­ï¼šã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
    #game-area {
      position: relative;
      flex: 1;
      overflow: hidden;
      background-image: url("images/bg_negi_field.png");
      background-size: cover;
      background-position: center bottom;
      border-top: 2px solid #e2c9a3;
      border-bottom: 2px solid #e2c9a3;
    }
    .lane-helper {
      position: absolute;
      left: 0; right: 0;
      top: 52%;
      transform: translateY(-50%);
      height: 0;
    }

    /* ãƒã‚®ï¼šã‚¹ãƒãƒ›ã§ã‚¿ãƒƒãƒ—ã—ã‚„ã™ãå¤§ãã‚ */
    .leek {
      position: absolute;
      bottom: 6vh;
      width: 30vw;
      min-width: 120px;
      max-width: 220px;
      cursor: pointer;
      touch-action: manipulation;
      transition: transform 0.08s;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .leek:active { transform: translateY(3px) scale(0.97); }

    /* å›å¾©ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆè¦‹åˆ†ã‘ã‚„ã™ãï¼‰ */
    .leek.heal {
      filter: saturate(1.2);
      outline: 4px solid rgba(102, 204, 102, 0.55);
      border-radius: 16px;
    }

    /* ç”»é¢å†…ãƒãƒƒãƒ—æ¼”å‡ºï¼ˆãµã‚ã£ã¨ä¸ŠãŒã‚‹æ–‡å­—ï¼‰ */
    .pop {
      position: absolute;
      pointer-events: none;
      font-weight: 900;
      font-size: 18px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.9);
      border: 2px solid rgba(255, 177, 90, 0.7);
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      transform: translate(-50%, -50%);
      animation: popUp 0.75s ease-out forwards;
      white-space: nowrap;
    }
    @keyframes popUp {
      0%   { opacity: 0; transform: translate(-50%, -35%) scale(0.95); }
      15%  { opacity: 1; transform: translate(-50%, -50%) scale(1.00); }
      100% { opacity: 0; transform: translate(-50%, -95%) scale(1.03); }
    }

    /* ä¸‹ï¼šãƒœã‚¿ãƒ³ */
    .controls { padding: 10px 16px 18px; text-align: center; }

    .btn-main {
      display: inline-block;
      padding: 12px 28px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(180deg, #ffb15a, #ff8b3d);
      color: #fff;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: 0.08em;
      box-shadow: 0 5px 0 #d96c23;
      cursor: pointer;
    }
    .btn-main:active { transform: translateY(2px); box-shadow: 0 3px 0 #d96c23; }

    /* ãƒªãƒˆãƒ©ã‚¤ã‚’è¦‹ãˆã‚„ã™ã */
    .btn-retry {
      display: none;
      margin-top: 10px;
      width: min(360px, 92%);
      padding: 14px 18px;
      font-size: 22px;
      font-weight: 900;
      border-radius: 16px;
      border: 3px solid rgba(255, 177, 90, 0.85);
      background: rgba(255, 255, 255, 0.95);
      color: #553322;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,0.14);
    }
    .btn-retry:active { transform: translateY(2px); }

    .small-note { margin-top: 6px; font-size: 10px; color: #b2997c; }
  </style>
</head>

<body>
  <div class="wrapper">
    <header class="hud">
      <div class="score">
        SCORE: <span id="score-value">0</span>
      </div>

      <div class="life-bar" id="life-bar">
        ãƒ©ã‚¤ãƒ•: <span id="life-value">7</span> / 7ã€€ï½œã€€ã‚³ãƒ³ãƒœ: <span id="combo-value">0</span>
      </div>

      <div id="rule-text"></div>
    </header>

    <main id="game-area">
      <div class="lane-helper" id="lane-helper"></div>
    </main>

    <footer class="controls">
      <button id="start-btn" class="btn-main">åç©«é–‹å§‹ï¼</button>
      <button id="retry-btn" class="btn-retry">ã‚‚ã†ä¸€å›åç©«ã™ã‚‹ï¼</button>

      <div class="small-note">
        â€» æ¯ã‚Œãƒã‚®ãƒ»æŠ˜ã‚Œãƒã‚®ã‚’è¦‹é€ƒã™ã¨ãƒ©ã‚¤ãƒ•ãŒæ¸›ã‚‹ã‚ˆã€‚<br>
        â€» é‡‘ãƒã‚®ã¯ +10ç‚¹ ï¼† 5ç§’é–“ã€Œæ¸›ç‚¹ã‚‚ãƒ©ã‚¤ãƒ•æ¸›å°‘ã‚‚ãªã—ã€âœ¨
      </div>
    </footer>
  </div>

  <script>
    // ==== ãƒã‚®ã‚¿ã‚¤ãƒ—è¨­å®š =========================
    const NEGI_TYPES = {
      good: [
        { name: "ç´°ãƒã‚®",  file: "negi_hoso.png" },
        { name: "æ™®é€šãƒã‚®", file: "negi_futsu.png" },
        { name: "å¤ªãƒã‚®",  file: "negi_futo.png" }
      ],
      bad: [
        { name: "æ¯ã‚Œãƒã‚®", file: "negi_kare.png" },
        { name: "æŠ˜ã‚Œãƒã‚®", file: "negi_ore.png" }
      ],
      gold: [
        { name: "é‡‘ãƒã‚®", file: "negi_gold.png" }
      ],
      // å›å¾©ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆæ–°ã—ã„ç”»åƒãªã—ã§å‹•ãã‚ˆã†ã«ã€æ—¢å­˜ã® neig_futsu.png ã‚’æµç”¨ï¼‰
      heal: [
        { name: "æ•‘æ€¥æŸãƒã‚®", file:  "negi_taba.png" }
      ]
    };

    // ==== DOM =======================
    const gameArea = document.getElementById("game-area");
    const scoreValueEl = document.getElementById("score-value");
    const lifeValueEl = document.getElementById("life-value");
    const comboValueEl = document.getElementById("combo-value");
    const startBtn = document.getElementById("start-btn");
    const retryBtn = document.getElementById("retry-btn");
    const bodyEl = document.body;
    const ruleTextEl = document.getElementById("rule-text");

    // ==== ãƒ«ãƒ¼ãƒ«æ–‡ï¼ˆé€šå¸¸è¡¨ç¤ºï¼‰ =====================
    const DEFAULT_RULE_HTML =
      'æ¯ã‚Œãƒã‚®ãƒ»æŠ˜ã‚Œãƒã‚®ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å–ã‚Šé™¤ã“ã†ï¼<br>' +
      'é‡‘ãƒã‚®ã¯ã‚¿ãƒƒãƒ—ã§ +10ç‚¹ ï¼† 5ç§’é–“ãƒŸã‚¹ã—ã¦ã‚‚æ¸›ç‚¹ã‚‚ãƒ©ã‚¤ãƒ•æ¸›å°‘ã‚‚ãªã—âœ¨';

    // ==== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ =====================
    let score = 0;
    let life = 7;
    let gameRunning = false;
    let leeks = [];

    let invincible = false;
    let invincibleTimeoutId = null;

    // ã‚³ãƒ³ãƒœ
    let combo = 0;
    let comboTimer = null;
    const COMBO_WINDOW_MS = 1200; // ã“ã‚Œä»¥å†…ã«æ‚ªãƒã‚®ã‚’ç¶šã‘ã¦ã‚¿ãƒƒãƒ—ã§ã‚³ãƒ³ãƒœç¶™ç¶š

    // ==== å‡ºç¾/é›£æ˜“åº¦ï¼ˆæ³¢ã‚’ã¤ãã‚‹ï¼‰ =====================
    const BASE_SPAWN_INTERVAL = 650; // å¹³å‡å‡ºç¾é–“éš”ï¼ˆmsï¼‰
    const BASE_SPEED = 3.2;          // åŸºæº–ã‚¹ãƒ”ãƒ¼ãƒ‰
    const WAVE_PERIOD_MS = 18000;    // æ³¢ã®å‘¨æœŸï¼ˆé™ã‹â†’ãƒ‰ãƒƒâ†’è½ã¡ç€ãï¼‰
    const WAVE_MIN = 0.85;           // æ³¢ã®æœ€ä½å€ç‡
    const WAVE_MAX = 1.40;           // æ³¢ã®æœ€é«˜å€ç‡

    // å‡ºç¾ç‡ï¼ˆæ‚ªã„ãƒã‚®å¤šã‚ + å›å¾©ã¯ãƒ¬ã‚¢ï¼‰
    // good 33% / bad 58% / gold 5% / heal 4%
    // â€» heal ã‚’ã‚‚ã£ã¨ãƒ¬ã‚¢ã«ã—ãŸã„ãªã‚‰ 1ã€œ2% ã«ã—ã¦OK
    const RATE = {
      good: 0.33,
      bad:  0.58,
      gold: 0.05,
      heal: 0.04
    };

    // ==== è¡¨ç¤ºç³» =====================
    function updateScore(delta) {
      score += delta;
      if (score < 0) score = 0;
      scoreValueEl.textContent = score;
    }

    function setLife(newLife) {
      life = Math.max(0, Math.min(7, newLife));
      lifeValueEl.textContent = life;
      if (life <= 0) stopGame(true);
    }

    function setCombo(newCombo) {
      combo = Math.max(0, newCombo);
      comboValueEl.textContent = combo;
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå¤§ãã„èª¬æ˜æ¬„ã«ä¸€æ™‚è¡¨ç¤ºï¼‰
    let ruleMsgTimer = null;
    function flashRuleMessage(html, ms = 900) {
      clearTimeout(ruleMsgTimer);
      ruleTextEl.innerHTML = html;
      ruleTextEl.classList.add("rule-flash");
      ruleMsgTimer = setTimeout(() => {
        ruleTextEl.classList.remove("rule-flash");
        ruleTextEl.innerHTML = DEFAULT_RULE_HTML;
      }, ms);
    }

    // ç”»é¢å†…ãƒãƒƒãƒ—æ¼”å‡ºï¼ˆã‚¿ãƒƒãƒ—åœ°ç‚¹ã«ãµã‚ã£ã¨ï¼‰
    function showPop(text, clientX, clientY) {
      const rect = gameArea.getBoundingClientRect();
      const x = clientX - rect.left;
      const y = clientY - rect.top;

      const el = document.createElement("div");
      el.className = "pop";
      el.textContent = text;
      el.style.left = x + "px";
      el.style.top = y + "px";
      gameArea.appendChild(el);

      setTimeout(() => {
        if (el && el.parentNode) el.parentNode.removeChild(el);
      }, 800);
    }

    function clearAllLeeks() {
      leeks.forEach(obj => {
        if (obj.el && obj.el.parentNode) obj.el.parentNode.removeChild(obj.el);
      });
      leeks = [];
    }

    function stopGameTimers() {
      // spawn ã¯ setTimeout ãƒ«ãƒ¼ãƒ—ãªã®ã§ timerId ã‚’æ¶ˆã™
      clearTimeout(spawnTimerId);
      clearInterval(moveTimerId);
      spawnTimerId = null;
      moveTimerId = null;
    }

    function setInvincible(on) {
      invincible = on;
      if (on) bodyEl.classList.add("invincible");
      else bodyEl.classList.remove("invincible");
    }

    // ==== ãƒŸã‚¹å‡¦ç† =====================
    function resetCombo() {
      clearTimeout(comboTimer);
      comboTimer = null;
      setCombo(0);
    }

    function registerMiss(message) {
      if (invincible) {
        flashRuleMessage("ç„¡æ•µä¸­âœ¨ ã„ã¾ã®ãƒŸã‚¹ã¯ãƒãƒ¼ã‚«ã‚¦ãƒ³ãƒˆï¼", 900);
        return;
      }
      resetCombo();
      setLife(life - 1);
      flashRuleMessage(message + `<br>ãƒ©ã‚¤ãƒ•ãŒæ¸›ã£ãŸâ€¦ï¼ˆæ®‹ã‚Š ${life}/7ï¼‰`, 1100);
    }

    // ==== æ³¢ã®å€ç‡ï¼ˆ0.85ã€œ1.40ãã‚‰ã„ã§ä¸Šä¸‹ï¼‰ =====================
    let startTimeMs = 0;
    function waveFactor(nowMs) {
      const t = (nowMs - startTimeMs) % WAVE_PERIOD_MS;
      const phase = (t / WAVE_PERIOD_MS) * Math.PI * 2; // 0..2Ï€
      // sin ã‚’ 0..1 ã«ã—ã¦ã‹ã‚‰ç¯„å›²ã¸
      const s01 = (Math.sin(phase - Math.PI/2) + 1) / 2; // å§‹ã‚é™ã‹å¯„ã‚Šã«
      return WAVE_MIN + (WAVE_MAX - WAVE_MIN) * s01;
    }

    // ==== ãƒã‚®ç”Ÿæˆ =====================
    function pickKind() {
      const r = Math.random();
      const a = RATE.good;
      const b = a + RATE.bad;
      const c = b + RATE.gold;
      // æ®‹ã‚ŠãŒ heal
      if (r < a) return "good";
      if (r < b) return "bad";
      if (r < c) return "gold";
      return "heal";
    }

    function spawnLeek() {
      if (!gameRunning) return;

      const kind = pickKind();
      const typeGroup = NEGI_TYPES[kind];
      const data = typeGroup[Math.floor(Math.random() * typeGroup.length)];

      const gameRect = gameArea.getBoundingClientRect();
      const yBottom = gameRect.height * 0.20;

      const img = document.createElement("img");
      img.src = "images/" + data.file;
      img.alt = data.name;
      img.className = "leek";
      img.draggable = false;
      img.style.bottom = yBottom + "px";

      if (kind === "heal") img.classList.add("heal");

      const obj = {
        el: img,
        kind,
        name: data.name,
        x: -Math.max(180, gameRect.width * 0.35),
        speed: 0,
        width: 0
      };

      // æ³¢ + ãƒ©ãƒ³ãƒ€ãƒ  + ç¨®é¡è£œæ­£
      const wf = waveFactor(performance.now());
      const base = BASE_SPEED * wf;

      // ç™½ãƒã‚®ï¼ˆgoodï¼‰ã¯æ—©ã‚ãƒ©ãƒ³ãƒ€ãƒ å¹…å¤§ãã‚
      // æ‚ªãƒã‚®ï¼ˆbadï¼‰ã‚‚ãã“ãã“é€Ÿã„ï¼ˆè¿½ã„ã¤ã‹ã›ã‚‹ï¼‰
      // gold/heal ã¯å°‘ã—é…ã‚ã§ã€Œç‹™ãˆã‚‹ã€ä½™ç™½
      let bonus = 0;
      if (kind === "good") bonus = 1.2;
      if (kind === "bad")  bonus = 0.8;
      if (kind === "gold") bonus = 0.2;
      if (kind === "heal") bonus = 0.2;

      obj.speed = base + bonus + Math.random() * (2.8 * wf);

      img.style.left = obj.x + "px";

      // ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒï¼ˆã‚¿ãƒƒãƒ—åœ°ç‚¹ã‚’å–å¾—ã—ã¦ãƒãƒƒãƒ—ã‚’å‡ºã™ãŸã‚ã€ã‚¤ãƒ™ãƒ³ãƒˆå¼•æ•°ã‚’æ¸¡ã™ï¼‰
      img.addEventListener("click", (e) => handleTapLeek(obj, e));
      img.addEventListener("touchend", (e) => {
        e.preventDefault();
        const t = e.changedTouches && e.changedTouches[0];
        handleTapLeek(obj, t || e);
      });

      gameArea.appendChild(img);

      requestAnimationFrame(() => {
        obj.width = img.getBoundingClientRect().width || 120;
      });

      leeks.push(obj);
    }

    // ==== ç§»å‹• =====================
    function moveLeeks() {
      if (!gameRunning) return;

      const gameRect = gameArea.getBoundingClientRect();
      const removeList = [];

      leeks.forEach(obj => {
        obj.x += obj.speed;
        obj.el.style.left = obj.x + "px";

        if (obj.x > gameRect.width + 10) {
          handleLeekReachedRight(obj);
          removeList.push(obj);
        }
      });

      removeList.forEach(obj => {
        if (obj.el && obj.el.parentNode) obj.el.parentNode.removeChild(obj.el);
        const idx = leeks.indexOf(obj);
        if (idx >= 0) leeks.splice(idx, 1);
      });
    }

    // ==== å³ç«¯åˆ°é”å‡¦ç† =====================
    function handleLeekReachedRight(obj) {
      if (obj.kind === "good") {
        updateScore(1);
      } else if (obj.kind === "bad") {
        if (!invincible) updateScore(-1);
        registerMiss(`è¦‹é€ƒã—ï¼${obj.name}ãŒæµã‚Œã¡ã‚ƒã£ãŸğŸ’¦`);
      } else if (obj.kind === "gold") {
        updateScore(1);
      } else if (obj.kind === "heal") {
        // å›å¾©ã‚¢ã‚¤ãƒ†ãƒ ã¯è¦‹é€ƒã—ã¦ã‚‚ãƒšãƒŠãƒ«ãƒ†ã‚£ãªã—ï¼ˆæ¬²ã—ã‘ã‚Œã°ã“ã“ã§ãƒŸã‚¹ã«å¤‰æ›´OKï¼‰
      }
    }

    // ==== ã‚¿ãƒƒãƒ—å‡¦ç† =====================
    function keepCombo() {
      clearTimeout(comboTimer);
      comboTimer = setTimeout(() => {
        resetCombo();
      }, COMBO_WINDOW_MS);
    }

    function handleTapLeek(obj, e) {
      if (!gameRunning || !obj.el) return;
      if (!gameArea.contains(obj.el)) return;

      const clientX = e && e.clientX ? e.clientX : (window.innerWidth / 2);
      const clientY = e && e.clientY ? e.clientY : (window.innerHeight / 2);

      if (obj.kind === "good") {
        if (!invincible) updateScore(-1);
        showPop(invincible ? "ã‚»ãƒ¼ãƒ•âœ¨" : "-1", clientX, clientY);
        registerMiss("ã¡ãŒã†ï¼è‰¯ã„ãƒã‚®ã‚’å–ã£ã¡ã‚ƒã£ãŸğŸ¥²");
      }

      if (obj.kind === "bad") {
        // ã‚³ãƒ³ãƒœåŠ ç‚¹ï¼ˆ+1, +2, +3â€¦ï¼‰
        const next = combo + 1;
        setCombo(next);
        keepCombo();

        // ã‚³ãƒ³ãƒœå¾—ç‚¹ï¼ˆæ°—æŒã¡ã„ã„ã‚„ã¤ï¼‰
        updateScore(next);
        showPop("+" + next + "ğŸ‘Œ", clientX, clientY);

        flashRuleMessage(`ãƒŠã‚¤ã‚¹ï¼å‚·ã‚“ã ãƒã‚®ã‚’å‡¦ç†ğŸ‘Œ<br><b>${next}ã‚³ãƒ³ãƒœï¼ +${next}ç‚¹</b>`, 850);
      }

      if (obj.kind === "gold") {
        updateScore(10);
        showPop("+10âœ¨", clientX, clientY);

        flashRuleMessage("é‡‘ãƒã‚®ã‚²ãƒƒãƒˆï¼<br><b>5ç§’é–“ ãƒãƒ¼ãƒšãƒŠãƒ«ãƒ†ã‚£âœ¨</b>", 1100);
        setInvincible(true);
        clearTimeout(invincibleTimeoutId);
        invincibleTimeoutId = setTimeout(() => setInvincible(false), 5000);
      }

      if (obj.kind === "heal") {
        // ãƒ©ã‚¤ãƒ•å›å¾©ï¼ˆæœ€å¤§7ï¼‰
        const before = life;
        if (before < 7) setLife(before + 1);
        showPop(before < 7 ? "ãƒ©ã‚¤ãƒ•+1ğŸ’š" : "æº€ã‚¿ãƒ³ğŸ’š", clientX, clientY);

        flashRuleMessage(before < 7
          ? "æ•‘æ€¥æŸãƒã‚®ï¼<br><b>ãƒ©ã‚¤ãƒ•ãŒ1å›å¾©ğŸ’š</b>"
          : "æ•‘æ€¥æŸãƒã‚®ï¼<br><b>ãƒ©ã‚¤ãƒ•ã¯æº€ã‚¿ãƒ³ã ã‚ˆğŸ’š</b>", 1000);
      }

      // ã‚¿ãƒƒãƒ—ã—ãŸãƒã‚®ã‚’å‰Šé™¤
      if (obj.el && obj.el.parentNode) obj.el.parentNode.removeChild(obj.el);
      const idx = leeks.indexOf(obj);
      if (idx >= 0) leeks.splice(idx, 1);
    }

    // ==== å‡ºç¾ãƒ«ãƒ¼ãƒ—ï¼ˆæ³¢ã«åˆã‚ã›ã¦é–“éš”ã‚’å¤‰ãˆã‚‹ï¼‰ =====================
    let spawnTimerId = null;
    let moveTimerId = null;

    function scheduleNextSpawn() {
      if (!gameRunning) return;
      const wf = waveFactor(performance.now());

      // æ³¢ãŒé«˜ã„ã»ã©ã€Œå‡ºç¾é–“éš”çŸ­ãã€ã™ã‚‹ï¼ˆãƒ‰ãƒƒã¨æ¥ã‚‹ï¼‰
      // ã•ã‚‰ã«å°‘ã—ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆæ°—æŒã¡ã„ã„æºã‚‰ãï¼‰
      const interval = (BASE_SPAWN_INTERVAL / wf) * (0.85 + Math.random() * 0.35);

      spawnTimerId = setTimeout(() => {
        spawnLeek();
        scheduleNextSpawn();
      }, interval);
    }

    // ==== ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ»çµ‚äº† =====================
    function startGame() {
      score = 0;
      updateScore(0);
      setLife(7);
      resetCombo();

      clearAllLeeks();
      stopGameTimers();

      setInvincible(false);
      ruleTextEl.innerHTML = DEFAULT_RULE_HTML;

      gameRunning = true;
      startTimeMs = performance.now();

      startBtn.textContent = "ãƒ—ãƒ¬ã‚¤ä¸­â€¦";
      startBtn.disabled = true;
      retryBtn.style.display = "none";

      // ãƒ«ãƒ¼ãƒ—é–‹å§‹
      scheduleNextSpawn();
      moveTimerId = setInterval(moveLeeks, 1000 / 60);

      flashRuleMessage("åç©«ã‚¹ã‚¿ãƒ¼ãƒˆï¼<br><b>æ‚ªã„ãƒã‚®ã‚’å©ã‘ãƒ¼ã£ğŸŒ¿</b>", 1000);
    }

    function stopGame(isGameOver = false) {
      gameRunning = false;
      stopGameTimers();
      setInvincible(false);
      resetCombo();

      startBtn.textContent = "åç©«é–‹å§‹ï¼";
      startBtn.disabled = false;

      if (isGameOver) {
        ruleTextEl.innerHTML = `ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼<br>æœ€çµ‚ã‚¹ã‚³ã‚¢ï¼š<b>${score}</b>`;
      } else {
        ruleTextEl.innerHTML = DEFAULT_RULE_HTML;
      }

      retryBtn.style.display = "inline-block";
    }

    // ==== ã‚¤ãƒ™ãƒ³ãƒˆ =====================
    startBtn.addEventListener("click", () => startGame());
    retryBtn.addEventListener("click", () => startGame());

    window.addEventListener("resize", () => {
      leeks.forEach(obj => {
        obj.x = parseFloat(obj.el.style.left) || obj.x;
      });
    });

    // åˆæœŸè¡¨ç¤º
    ruleTextEl.innerHTML = DEFAULT_RULE_HTML;
  </script>
</body>
</html>
